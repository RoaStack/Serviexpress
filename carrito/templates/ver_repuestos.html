{% extends 'base.html' %}
{% load static %}

{% block title %}E-Commerce{% endblock %}

{% block body_class %}cliente-body{% endblock %}
{% block main_class %}p-0 m-0 w-100{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/carrito/ecommerce.css' %}">
{% endblock %}

{% block content %}

<div class="container py-4">

    <h2 class="text-center mb-4">Repuestos Disponibles</h2>

    <div class="row g-4">

        {% for repuesto in repuestos %}
        <div class="col-6 col-md-4 col-lg-3">

            <div class="card">

                <img src="{{ repuesto.foto.url }}" class="card-img-top" alt="{{ repuesto.nombre }}">

                <div class="card-body">

                    <h5 class="card-title">{{ repuesto.nombre }}</h5>
                    <h6 class="card-subtitle mb-2">{{ repuesto.marca }}</h6>

                    <p class="mb-1">Precio: ${{ repuesto.precio_venta }}</p>
                    <p class="mb-2">Stock: {{ repuesto.stock }}</p>

                    <form class="form-agregar" data-id="{{ repuesto.id }}">
                        {% csrf_token %}
                        <div class="d-flex gap-2">
                            <input type="number" name="cantidad" value="1"
                                   min="1" class="form-control form-control-sm">
                            <button type="submit" class="btn btn-success btn-sm">Agregar</button>
                        </div>
                    </form>

                </div>

            </div>

        </div>
        {% empty %}
        <p class="text-center">No hay repuestos disponibles.</p>
        {% endfor %}

    </div>

</div>

<!-- üõí BOT√ìN FLOTANTE -->
<button class="btn btn-primary position-fixed bottom-0 end-0 m-4"
        data-bs-toggle="offcanvas"
        data-bs-target="#carritoOffcanvas">
    üõí Carrito <span id="cart-badge" class="badge bg-danger" style="display:none;">0</span>
</button>

<!-- üõí OFFCANVAS CARRITO -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="carritoOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Carrito de compras</h5>
        <button type="button" class="btn-close btn-close-white"
                data-bs-dismiss="offcanvas"></button>
    </div>

    <div class="offcanvas-body">

        <div id="carrito-detalle">
            <!-- El AJAX coloca aqu√≠ el HTML del carrito -->
        </div>

        <button id="vaciar-btn" class="btn btn-danger mt-3 w-100">
            Vaciar carrito üóëÔ∏è
        </button>

    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/* ‚¨áÔ∏è Mantengo EXACTAMENTE tus scripts, sin cambiar nada */

// üîπ Actualiza el contador (badge rojo)
function actualizarIndicador(items) {
  const badge = document.getElementById('cart-badge');
  if (items > 0) {
    badge.textContent = items;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
}

// üîπ Cargar detalle del carrito
function cargarCarrito() {
  fetch("{% url 'ecommerce:detalle_carrito_ajax' %}")
    .then(res => res.json())
    .then(data => {
      document.getElementById('carrito-detalle').innerHTML = data.html;

      const filas = document.querySelectorAll('#carrito-detalle tbody tr');
      let totalItems = 0;

      filas.forEach(fila => {
        const cantidadCelda = fila.children[1];
        if (cantidadCelda) {
          const valor = parseInt(cantidadCelda.textContent);
          if (!isNaN(valor)) totalItems += valor;
        }
      });

      actualizarIndicador(totalItems);
    });
}

// üîπ Vaciar carrito por AJAX
function vaciarCarrito() {
  fetch("{% url 'ecommerce:vaciar_carrito' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCSRFToken(),
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      cargarCarrito();
    }
  });
}

// üîπ Obtener CSRF desde cookies
function getCSRFToken() {
  const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
  return cookie ? cookie.split('=')[1] : '';
}

// üîπ Vaciar carrito bot√≥n
document.addEventListener('click', function (e) {
  if (e.target && e.target.id === 'vaciar-btn') {
    e.preventDefault();
    if (confirm('¬øSeguro que deseas vaciar el carrito? üóëÔ∏è')) {
      vaciarCarrito();
    }
  }
});

// üîπ Inicializaci√≥n
document.addEventListener('DOMContentLoaded', () => {

  const offcanvasEl = document.getElementById('carritoOffcanvas');
  offcanvasEl.addEventListener('show.bs.offcanvas', cargarCarrito);

  document.querySelectorAll('.form-agregar').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      const repuestoId = this.dataset.id;
      const cantidad = this.querySelector('input[name="cantidad"]').value;
      const csrftoken = this.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch(`/ecommerce/carrito/agregar_ajax/${repuestoId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
        body: new URLSearchParams({cantidad: cantidad})
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          cargarCarrito();
          actualizarIndicador(data.items);
        }
      });
    });
  });

  cargarCarrito();
});
</script>
{% endblock %}


