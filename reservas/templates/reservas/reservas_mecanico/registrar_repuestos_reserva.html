{% extends 'base.html' %}
{% load static %}

{% load static %}

{% block title %}Registrar repuestos ‚Äî Reserva #{{ reserva.id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reservas/registrar_repuestos.css' %}">
{% endblock %}

{% block body_class %}mecanico-body{% endblock %}
{% block main_class %}p-0 m-0 w-100{% endblock %}
    

{% block content %}

<div class="hsm-overlay">
    <div class="hsm-inner">

        <!-- Bot√≥n volver -->
        <div class="hsm-back-row">
            <a href="{% url 'reservas:servicios_en_proceso' %}" class="hsm-back-link">‚¨Ö Volver</a>
        </div>

<div class="hsm-overlay">
    <div class="hsm-inner">

        <!-- Bot√≥n volver -->
        <div class="hsm-back-row">
            <a href="{% url 'reservas:servicios_en_proceso' %}" class="hsm-back-link">‚¨Ö Volver</a>
        </div>

        <!-- T√≠tulo -->
        <h2 class="hsm-title">üî© Registrar repuestos ‚Äî Reserva #{{ reserva.id }}</h2>

        <!-- Tarjeta principal -->
        <div class="hsm-card">

            <!-- Mensaje informativo -->
            <div class="alert alert-info text-center fw-semibold">
                üí° Los repuestos agregados descuentan stock autom√°ticamente.<br>
                Si eliminas un repuesto, su cantidad se devolver√° al inventario.
            </div>
        <!-- T√≠tulo -->
        <h2 class="hsm-title">üî© Registrar repuestos ‚Äî Reserva #{{ reserva.id }}</h2>

        <!-- Tarjeta principal -->
        <div class="hsm-card">

            <!-- Mensaje informativo -->
            <div class="alert alert-info text-center fw-semibold">
                üí° Los repuestos agregados descuentan stock autom√°ticamente.<br>
                Si eliminas un repuesto, su cantidad se devolver√° al inventario.
            </div>

            <!-- FORMULARIO -->
            <form method="POST" class="row g-3 mb-4">
                {% csrf_token %}
                <div class="col-md-4 text-white">
                    {{ form.repuesto.label_tag }}
                    {{ form.repuesto }}
                </div>

                <div class="col-md-3 text-white">
                    {{ form.cantidad.label_tag }}
                    {{ form.cantidad }}
                </div>

                <div class="col-md-3 text-white">
                    {{ form.precio_unitario.label_tag }}
                    {{ form.precio_unitario }}
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-success w-100" type="submit">‚ûï Agregar</button>
                </div>
            </form>
            <!-- FORMULARIO -->
            <form method="POST" class="row g-3 mb-4">
                {% csrf_token %}
                <div class="col-md-4 text-white">
                    {{ form.repuesto.label_tag }}
                    {{ form.repuesto }}
                </div>

                <div class="col-md-3 text-white">
                    {{ form.cantidad.label_tag }}
                    {{ form.cantidad }}
                </div>

                <div class="col-md-3 text-white">
                    {{ form.precio_unitario.label_tag }}
                    {{ form.precio_unitario }}
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-success w-100" type="submit">‚ûï Agregar</button>
                </div>
            </form>

            <!-- T√≠tulo tabla -->
            <h4 class="text-danger fw-bold mb-3">
                <i class="bi bi-clipboard2-check-fill"></i> Repuestos registrados
            </h4>
            <!-- T√≠tulo tabla -->
            <h4 class="text-danger fw-bold mb-3">
                <i class="bi bi-clipboard2-check-fill"></i> Repuestos registrados
            </h4>

            {% if detalles %}

            <!-- Tabla estilo profesional -->
            <div class="hsm-table-wrapper">
                <table class="hsm-table">
                    <thead>
                        <tr>
                            <th>Repuesto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in detalles %}
                        <tr>
                            <td>{{ d.repuesto.nombre }}</td>
                            <td>{{ d.cantidad }}</td>
                            <td>${{ d.precio_unitario|floatformat:0 }}</td>
                            <td>${{ d.subtotal|floatformat:0 }}</td>
                            <td>
                                <form method="POST" action="{% url 'reservas:eliminar_repuesto_detalle' reserva.id d.id %}">
                                    {% csrf_token %}
                                    <button class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('¬øSeguro que deseas eliminar este repuesto y restaurar el stock?')">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end fw-bold">üí∞ Total</td>
                            <td colspan="2" class="fw-bold">${{ total_repuestos|floatformat:0 }}</td>
                        </tr>
                    </tfoot>

                </table>
            </div>

            {% else %}
            <p class="hsm-empty">No hay repuestos registrados a√∫n.</p>
            {% endif %}

            <!-- Finalizar -->
            <div class="text-end mt-4">
                {% if detalles %}
                <a href="{% url 'reservas:actualizar_estado_mecanico' reserva.id 'finalizada' %}"
                   class="btn btn-success fw-bold"
                   onclick="return confirm('¬øSeguro que deseas finalizar esta reserva? Se generar√° la boleta autom√°ticamente.');">
                   ‚úÖ Finalizar servicio
                </a>
                {% else %}
                <button class="btn btn-secondary fw-bold" disabled>
                    üîí Finalizar servicio
                </button>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<!-- Script autocompletado de precio -->
<!-- Script autocompletado de precio -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const repuestoSelect = document.getElementById("id_repuesto");
        const precioInput = document.getElementById("id_precio_unitario");
    document.addEventListener("DOMContentLoaded", function() {
        const repuestoSelect = document.getElementById("id_repuesto");
        const precioInput = document.getElementById("id_precio_unitario");

        repuestoSelect.addEventListener("change", function() {
            const text = repuestoSelect.options[repuestoSelect.selectedIndex].text;
            const match = text.match(/\$(\d+)/);
            precioInput.value = match ? match[1] : "";
        });
    });
        repuestoSelect.addEventListener("change", function() {
            const text = repuestoSelect.options[repuestoSelect.selectedIndex].text;
            const match = text.match(/\$(\d+)/);
            precioInput.value = match ? match[1] : "";
        });
    });
</script>

{% endblock %}
